<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ '/assets/style.css' | url }}">
    <title>{{ title or 'KimBlogg' }}</title>
  </head>
  <body>
    <nav class="site-nav" aria-label="Hovednavigasjon">
      <div class="container nav-inner">
        <a class="brand" href="/">KimBlogg</a>
        <div class="nav-links">
          <a href="/">Hjem</a>
          <a href="/blog/">Blogg</a>
          <a href="/admin/">Admin</a>
          <a href="#" id="id-account">Konto</a>
        </div>
      </div>
    </nav>

    <main class="container prose" id="main-content">
      {% block content %}
        {{ content | safe }}
      {% endblock %}
    </main>

    <footer class="site-footer">
      <div class="container">© {{ "" | year }} Kim Halvar Thoresen</div>
    </footer>

    <!-- Netlify Identity widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      (function () {
        function hasToken(hash) {
          return !!hash && (hash.includes('invite_token=') || hash.includes('recovery_token='));
        }
        function openModalForHash(hash) {
          if (!hash || !window.netlifyIdentity) return;
          if (hash.includes('invite_token=')) { netlifyIdentity.open('signup'); }
          else if (hash.includes('recovery_token=')) { netlifyIdentity.open('login'); }
        }

        function initIdentity() {
          if (!window.netlifyIdentity) return;

          netlifyIdentity.init();

          // Logg feil til konsoll, ikke i UI
          netlifyIdentity.on('error', (err) => {
            console.error('[Identity suppressed error]', err);
          });

          // "Konto"-lenke: åpner login/profil-panelet
          const account = document.getElementById('id-account');
          if (account) {
            account.addEventListener('click', (e) => {
              e.preventDefault();
              netlifyIdentity.open(); // login hvis utlogget, profil hvis innlogget
            });
          }

          const tokenPresent = hasToken(window.location.hash);

          if (tokenPresent) {
            // Ved magic-link (invite/reset): etter auto-login, åpne profil-panelet for å kunne endre passord
            netlifyIdentity.on('login', () => {
              // Fjern token fra URL så det ikke trigges igjen
              history.replaceState(null, '', window.location.pathname + window.location.search);
              // La Identity lande før vi åpner panelet
              setTimeout(() => netlifyIdentity.open(), 50);
              // Ingen redirect her – du kan sette passord først via "Change password"
            });
          } else {
            // Normal innlogging uten token → rett til admin
            netlifyIdentity.on('login', () => { window.location.href = '/admin/'; });
          }

          netlifyIdentity.on('logout', () => { window.location.href = '/'; });

          // Håndter innkommende token-hash
          openModalForHash(window.location.hash);
          window.addEventListener('hashchange', () => openModalForHash(window.location.hash));
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initIdentity);
        } else {
          initIdentity();
        }
      })();
    </script>
  </body>
</html>
